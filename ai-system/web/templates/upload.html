{% extends "base.html" %}

{% block title %}Upload D·ªØ Li·ªáu - AI Labeling System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-center mb-4">
            <i class="fas fa-upload me-2"></i>Upload D·ªØ Li·ªáu
            <small class="text-muted d-block">Import d·ªØ li·ªáu t·ª´ file CSV ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë√°nh nh√£n</small>
        </h1>
    </div>
</div>

<!-- Upload Form -->
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="content-box">
            <h5><i class="fas fa-file-csv me-2"></i>Ch·ªçn File CSV</h5>
            <p class="text-muted">File CSV ph·∫£i c√≥ c·ªôt "text" ch·ª©a n·ªôi dung c·∫ßn ƒë√°nh nh√£n</p>
            
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="file" class="form-label">Ch·ªçn File CSV</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                    <div class="form-text">Ch·ªâ ch·∫•p nh·∫≠n file .csv</div>
                </div>
                
                <div class="mb-3">
                    <label for="dataType" class="form-label">Lo·∫°i D·ªØ Li·ªáu</label>
                    <select class="form-select" id="dataType" name="data_type" required>
                        <option value="">Ch·ªçn lo·∫°i d·ªØ li·ªáu...</option>
                        <option value="sentiment">Sentiment Analysis - Ph√¢n t√≠ch c·∫£m x√∫c</option>
                        <option value="chatbot">Chatbot - T∆∞ v·∫•n kh√°ch h√†ng</option>
                        <option value="recommendation">Recommendation - G·ª£i √Ω s·∫£n ph·∫©m</option>
                    </select>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-custom">
                        <i class="fas fa-upload me-2"></i>Upload D·ªØ Li·ªáu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sample Data Format -->
<div class="row mt-4">
    <div class="col-12">
        <div class="content-box">
            <h5><i class="fas fa-info-circle me-2"></i>ƒê·ªãnh D·∫°ng File CSV</h5>
            <p class="text-muted">File CSV c·ªßa b·∫°n c·∫ßn c√≥ c·∫•u tr√∫c nh∆∞ sau:</p>
            
            <div class="row">
                <div class="col-md-4">
                    <h6>Sentiment Analysis</h6>
                    <pre class="bg-light p-3 rounded"><code>text
"S·∫£n ph·∫©m r·∫•t t·ªët, t√¥i r·∫•t h√†i l√≤ng"
"Ch·∫•t l∆∞·ª£ng t·ªá, kh√¥ng ƒë√°ng ti·ªÅn"
"D·ªãch v·ª• giao h√†ng nhanh"</code></pre>
                </div>
                
                <div class="col-md-4">
                    <h6>Chatbot</h6>
                    <pre class="bg-light p-3 rounded"><code>text
"Xin ch√†o, t√¥i c·∫ßn t∆∞ v·∫•n"
"S·∫£n ph·∫©m n√†y c√≥ gi√° bao nhi√™u?"
"C√≤n h√†ng kh√¥ng?"</code></pre>
                </div>
                
                <div class="col-md-4">
                    <h6>Recommendation</h6>
                    <pre class="bg-light p-3 rounded"><code>text,user_id,product_id
"User interaction 1",1,101
"User interaction 2",2,102
"User interaction 3",3,103</code></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload History -->
<div class="row mt-4">
    <div class="col-12">
        <div class="content-box">
            <h5><i class="fas fa-history me-2"></i>L·ªãch S·ª≠ Upload</h5>
            <div id="uploadHistory">
                <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu upload n√†o</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="content-box text-center">
            <h5><i class="fas fa-bolt me-2"></i>Thao T√°c Nhanh</h5>
            <div class="btn-group" role="group">
                <a href="/" class="btn btn-outline-primary btn-custom">
                    <i class="fas fa-home me-1"></i>V·ªÅ Trang Ch·ªß
                </a>
                <button class="btn btn-outline-success btn-custom" onclick="createSampleData()">
                    <i class="fas fa-plus me-1"></i>T·∫°o D·ªØ Li·ªáu M·∫´u
                </button>
                <button class="btn btn-outline-info btn-custom" onclick="refreshStats()">
                    <i class="fas fa-refresh me-1"></i>L√†m M·ªõi Th·ªëng K√™
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('file');
    const dataType = document.getElementById('dataType').value;
    
    if (!fileInput.files[0]) {
        showAlert('warning', '‚ö†Ô∏è Vui l√≤ng ch·ªçn file CSV!');
        return;
    }
    
    if (!dataType) {
        showAlert('warning', '‚ö†Ô∏è Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu!');
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    formData.append('data_type', dataType);
    
    showAlert('info', 'üì§ ƒêang upload d·ªØ li·ªáu...');
    
    axios.post('/upload_csv', formData, {
        headers: {
            'Content-Type': 'multipart/form-data'
        }
    })
    .then(response => {
        if (response.data.success) {
            showAlert('success', `‚úÖ ${response.data.message}`);
            addToHistory(dataType, fileInput.files[0].name, response.data.imported_count);
            document.getElementById('uploadForm').reset();
        } else {
            showAlert('danger', `‚ùå ${response.data.message}`);
        }
    })
    .catch(error => {
        showAlert('danger', `‚ùå Error: ${error.message}`);
    });
});

function addToHistory(dataType, fileName, count) {
    const historyDiv = document.getElementById('uploadHistory');
    const timestamp = new Date().toLocaleString('vi-VN');
    
    const historyItem = document.createElement('div');
    historyItem.className = 'alert alert-success alert-dismissible fade show';
    historyItem.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        <strong>${dataType.toUpperCase()}</strong> - ${fileName} 
        <span class="badge bg-primary ms-2">${count} samples</span>
        <small class="text-muted ms-2">${timestamp}</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    if (historyDiv.querySelector('.text-muted')) {
        historyDiv.innerHTML = '';
    }
    
    historyDiv.appendChild(historyItem);
}

function createSampleData() {
    showAlert('info', 'üîß ƒêang t·∫°o d·ªØ li·ªáu m·∫´u...');
    
    // T·∫°o d·ªØ li·ªáu m·∫´u cho t·ª´ng lo·∫°i
    const sampleData = {
        sentiment: [
            "S·∫£n ph·∫©m r·∫•t t·ªët, t√¥i r·∫•t h√†i l√≤ng v·ªõi ch·∫•t l∆∞·ª£ng",
            "Ch·∫•t l∆∞·ª£ng t·ªá, kh√¥ng ƒë√°ng ti·ªÅn b·ªè ra",
            "D·ªãch v·ª• giao h√†ng nhanh, ƒë√≥ng g√≥i c·∫©n th·∫≠n",
            "S·∫£n ph·∫©m ƒë√∫ng nh∆∞ m√¥ t·∫£, gi√° c·∫£ h·ª£p l√Ω",
            "Kh√¥ng h√†i l√≤ng v·ªõi s·∫£n ph·∫©m n√†y, ch·∫•t l∆∞·ª£ng k√©m"
        ],
        chatbot: [
            "Xin ch√†o, t√¥i c·∫ßn t∆∞ v·∫•n v·ªÅ s·∫£n ph·∫©m",
            "S·∫£n ph·∫©m n√†y c√≥ gi√° bao nhi√™u?",
            "C√≤n h√†ng kh√¥ng? Khi n√†o giao ƒë∆∞·ª£c?",
            "B·∫£o h√†nh s·∫£n ph·∫©m n√†y nh∆∞ th·∫ø n√†o?",
            "C·∫£m ∆°n, t·∫°m bi·ªát"
        ],
        recommendation: [
            "User interaction 1",
            "User interaction 2", 
            "User interaction 3",
            "User interaction 4",
            "User interaction 5"
        ]
    };
    
    // T·∫°o file CSV m·∫´u
    Object.keys(sampleData).forEach(dataType => {
        const csvContent = 'text\n' + sampleData[dataType].map(text => `"${text}"`).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sample_${dataType}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    });
    
    showAlert('success', '‚úÖ ƒê√£ t·∫°o file CSV m·∫´u cho t·∫•t c·∫£ lo·∫°i d·ªØ li·ªáu!');
}

function refreshStats() {
    showAlert('info', 'üîÑ ƒêang l√†m m·ªõi th·ªëng k√™...');
    location.reload();
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.main-container').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}

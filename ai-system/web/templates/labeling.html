{% extends "base.html" %}

{% block title %}Đánh Nhãn {{ data_type.title() }} - AI Labeling System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-center mb-4">
            <i class="fas fa-edit me-2"></i>Đánh Nhãn {{ data_type.title() }}
            <small class="text-muted d-block">Gán nhãn dữ liệu cho {{ data_type }} model</small>
        </h1>
    </div>
</div>

<div class="row">
    <!-- Main Labeling Area -->
    <div class="col-md-8">
        <div class="content-box">
            <h5><i class="fas fa-file-text me-2"></i>Nội Dung Cần Đánh Nhãn</h5>
            <div class="text-content" id="textContent">
                {{ data.content }}
            </div>
            
            <!-- Labeling Controls -->
            <div class="mt-3">
                <div class="row">
                    <div class="col-md-6">
                        <button id="prevSample" class="btn btn-outline-primary btn-custom">
                            <i class="fas fa-arrow-left me-1"></i>Mẫu Trước
                        </button>
                        <button id="nextSample" class="btn btn-outline-primary btn-custom">
                            <i class="fas fa-arrow-right me-1"></i>Mẫu Tiếp
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="saveLabel" class="btn btn-success btn-custom">
                            <i class="fas fa-save me-1"></i>Lưu Nhãn
                        </button>
                        <button id="skipSample" class="btn btn-warning btn-custom">
                            <i class="fas fa-forward me-1"></i>Bỏ Qua
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Labeling Controls -->
    <div class="col-md-4">
        {% if data_type == 'sentiment' %}
        <!-- Sentiment Labels -->
        <div class="content-box">
            <h6><i class="fas fa-heart me-2"></i>Sentiment Labels</h6>
            <div class="mb-3">
                <label class="form-label">Chọn Sentiment:</label>
                <div class="sentiment-options">
                    {% for sentiment, info in sentiment_labels.items() %}
                    <button class="btn btn-outline-primary label-btn sentiment-btn" 
                            data-sentiment="{{ sentiment }}"
                            style="border-color: {{ info.color }}; color: {{ info.color }};">
                        {{ info.icon }} {{ info.text }}
                    </button>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <small class="text-muted">Đã chọn: <span id="selectedSentiment">Chưa chọn</span></small>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Chọn Rating:</label>
                <div class="rating-options">
                    {% for rating, info in rating_labels.items() %}
                    <button class="btn btn-outline-warning label-btn rating-btn" 
                            data-rating="{{ rating }}"
                            style="border-color: {{ info.color }}; color: {{ info.color }};">
                        {{ rating }} ⭐ {{ info.text }}
                    </button>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <small class="text-muted">Đã chọn: <span id="selectedRating">Chưa chọn</span></small>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if data_type == 'chatbot' %}
        <!-- Intent Labels -->
        <div class="content-box">
            <h6><i class="fas fa-robot me-2"></i>Intent Labels</h6>
            <div class="mb-3">
                <label class="form-label">Chọn Intent:</label>
                <div class="intent-options">
                    {% for intent, info in intent_labels.items() %}
                    <button class="btn btn-outline-info label-btn intent-btn" 
                            data-intent="{{ intent }}"
                            style="border-color: {{ info.color }}; color: {{ info.color }};">
                        {{ info.text }}
                    </button>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <small class="text-muted">Đã chọn: <span id="selectedIntent">Chưa chọn</span></small>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if data_type == 'recommendation' %}
        <!-- Recommendation Labels -->
        <div class="content-box">
            <h6><i class="fas fa-thumbs-up me-2"></i>Recommendation Labels</h6>
            <div class="mb-3">
                <label class="form-label">User ID:</label>
                <input type="text" class="form-control" id="userId" placeholder="Nhập User ID">
            </div>
            <div class="mb-3">
                <label class="form-label">Product ID:</label>
                <input type="text" class="form-control" id="productId" placeholder="Nhập Product ID">
            </div>
            <div class="mb-3">
                <label class="form-label">Rating:</label>
                <div class="rating-options">
                    {% for rating, info in rating_labels.items() %}
                    <button class="btn btn-outline-warning label-btn rating-btn" 
                            data-rating="{{ rating }}"
                            style="border-color: {{ info.color }}; color: {{ info.color }};">
                        {{ rating }} ⭐ {{ info.text }}
                    </button>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <small class="text-muted">Đã chọn: <span id="selectedRating">Chưa chọn</span></small>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Progress -->
        <div class="content-box">
            <h6><i class="fas fa-chart-line me-2"></i>Tiến Độ</h6>
            <div class="progress mb-2">
                <div class="progress-bar progress-bar-custom" role="progressbar" style="width: 0%"></div>
            </div>
            <small class="text-muted">Mẫu 1 của 100</small>
        </div>
        
        <!-- Instructions -->
        <div class="content-box">
            <h6><i class="fas fa-info-circle me-2"></i>Hướng Dẫn</h6>
            <ul class="list-unstyled">
                <li><i class="fas fa-check text-success me-2"></i>Đọc kỹ nội dung</li>
                <li><i class="fas fa-check text-success me-2"></i>Chọn nhãn phù hợp</li>
                <li><i class="fas fa-check text-success me-2"></i>Click "Lưu Nhãn"</li>
                <li><i class="fas fa-check text-success me-2"></i>Chuyển sang mẫu tiếp</li>
            </ul>
        </div>
    </div>
</div>

<!-- Current Labels Display -->
<div class="row mt-4">
    <div class="col-12">
        <div class="content-box">
            <h5><i class="fas fa-list me-2"></i>Nhãn Đã Chọn</h5>
            <div id="currentLabels">
                <p class="text-muted">Chưa có nhãn nào được chọn</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentData = {{ data | tojson }};
let selectedLabels = {};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    updateCurrentLabels();
});

function setupEventListeners() {
    // Sentiment buttons
    document.querySelectorAll('.sentiment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            selectSentiment(this.dataset.sentiment);
        });
    });
    
    // Rating buttons
    document.querySelectorAll('.rating-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            selectRating(parseInt(this.dataset.rating));
        });
    });
    
    // Intent buttons
    document.querySelectorAll('.intent-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            selectIntent(this.dataset.intent);
        });
    });
    
    // Action buttons
    document.getElementById('saveLabel').addEventListener('click', saveLabel);
    document.getElementById('skipSample').addEventListener('click', skipSample);
    document.getElementById('nextSample').addEventListener('click', nextSample);
    document.getElementById('prevSample').addEventListener('click', prevSample);
}

function selectSentiment(sentiment) {
    // Update UI
    document.querySelectorAll('.sentiment-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    document.getElementById('selectedSentiment').textContent = sentiment;
    selectedLabels.sentiment = sentiment;
    updateCurrentLabels();
}

function selectRating(rating) {
    // Update UI
    document.querySelectorAll('.rating-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    document.getElementById('selectedRating').textContent = rating + ' sao';
    selectedLabels.rating = rating;
    updateCurrentLabels();
}

function selectIntent(intent) {
    // Update UI
    document.querySelectorAll('.intent-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    document.getElementById('selectedIntent').textContent = intent;
    selectedLabels.intent = intent;
    updateCurrentLabels();
}

function updateCurrentLabels() {
    const labelsDiv = document.getElementById('currentLabels');
    const labels = [];
    
    if (selectedLabels.sentiment) {
        labels.push(`<span class="badge bg-primary me-2">Sentiment: ${selectedLabels.sentiment}</span>`);
    }
    
    if (selectedLabels.rating) {
        labels.push(`<span class="badge bg-warning me-2">Rating: ${selectedLabels.rating} sao</span>`);
    }
    
    if (selectedLabels.intent) {
        labels.push(`<span class="badge bg-info me-2">Intent: ${selectedLabels.intent}</span>`);
    }
    
    if (labels.length > 0) {
        labelsDiv.innerHTML = labels.join('');
    } else {
        labelsDiv.innerHTML = '<p class="text-muted">Chưa có nhãn nào được chọn</p>';
    }
}

function saveLabel() {
    const dataType = '{{ data_type }}';
    let endpoint = '';
    let data = {
        raw_data_id: currentData.id,
        confidence: 1.0
    };
    
    if (dataType === 'sentiment') {
        if (!selectedLabels.sentiment || !selectedLabels.rating) {
            showAlert('warning', '⚠️ Vui lòng chọn sentiment và rating!');
            return;
        }
        endpoint = '/submit_sentiment_label';
        data.sentiment = selectedLabels.sentiment;
        data.rating = selectedLabels.rating;
    } else if (dataType === 'chatbot') {
        if (!selectedLabels.intent) {
            showAlert('warning', '⚠️ Vui lòng chọn intent!');
            return;
        }
        endpoint = '/submit_chatbot_label';
        data.intent = selectedLabels.intent;
        data.entities = {};
    } else if (dataType === 'recommendation') {
        const userId = document.getElementById('userId').value;
        const productId = document.getElementById('productId').value;
        
        if (!userId || !productId || !selectedLabels.rating) {
            showAlert('warning', '⚠️ Vui lòng nhập đầy đủ thông tin!');
            return;
        }
        endpoint = '/submit_recommendation_label';
        data.user_id = userId;
        data.product_id = productId;
        data.rating = selectedLabels.rating;
    }
    
    showAlert('info', '💾 Đang lưu nhãn...');
    
    axios.post(endpoint, data)
        .then(response => {
            if (response.data.success) {
                showAlert('success', '✅ Nhãn đã được lưu thành công!');
                nextSample();
            } else {
                showAlert('danger', `❌ ${response.data.message}`);
            }
        })
        .catch(error => {
            showAlert('danger', `❌ Error: ${error.message}`);
        });
}

function skipSample() {
    showAlert('info', '⏭️ Đã bỏ qua mẫu này');
    nextSample();
}

function nextSample() {
    // Reset labels
    selectedLabels = {};
    document.querySelectorAll('.label-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Clear form inputs
    const userIdInput = document.getElementById('userId');
    const productIdInput = document.getElementById('productId');
    if (userIdInput) userIdInput.value = '';
    if (productIdInput) productIdInput.value = '';
    
    // Update display
    document.getElementById('selectedSentiment').textContent = 'Chưa chọn';
    document.getElementById('selectedRating').textContent = 'Chưa chọn';
    document.getElementById('selectedIntent').textContent = 'Chưa chọn';
    
    // Load next sample
    location.reload();
}

function prevSample() {
    showAlert('info', '⏮️ Chuyển về mẫu trước');
    // Implementation for previous sample
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.main-container').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>

<style>
.sentiment-options, .rating-options, .intent-options {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.label-btn.active {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.text-content {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 20px;
    font-size: 18px;
    line-height: 1.6;
    min-height: 150px;
    margin-bottom: 20px;
}
</style>
{% endblock %}

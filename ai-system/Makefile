# AI System Makefile
# Chá»©c nÄƒng: Quáº£n lÃ½ toÃ n bá»™ há»‡ thá»‘ng AI cho e-commerce

.PHONY: install train agents-api agents-test nlp-api nlp-test web-api web-test clean lint fmt help

# Default target
help:
	@echo "ğŸ¤– AI System Commands"
	@echo "====================="
	@echo "install     - CÃ i Ä‘áº·t táº¥t cáº£ dependencies"
	@echo "train       - Train AI models"
	@echo "agents-api  - Cháº¡y Agents API server"
	@echo "agents-test - Test Agents system"
	@echo "nlp-api     - Cháº¡y NLP API server"
	@echo "nlp-test    - Test NLP system"
	@echo "web-api     - Cháº¡y Web API server"
	@echo "web-test    - Test Web system"
	@echo "all-apis    - Cháº¡y táº¥t cáº£ API servers"
	@echo "all-tests   - Cháº¡y táº¥t cáº£ tests"
	@echo "clean       - Dá»n dáº¹p files táº¡m"
	@echo "lint        - Kiá»ƒm tra code style"
	@echo "fmt         - Format code"
	@echo "help        - Hiá»ƒn thá»‹ help nÃ y"

# Install all dependencies
install:
	@echo "ğŸ“¦ Installing all dependencies..."
	pip install -r requirements.txt
	@echo "âœ… Dependencies installed"

# Train AI models
train:
	@echo "ğŸš€ Training AI models..."
	python scripts/train_models.py
	@echo "âœ… Training completed"

# Agents API
agents-api:
	@echo "ğŸ¤– Starting Agents API server..."
	cd agents && make api

agents-test:
	@echo "ğŸ§ª Testing Agents system..."
	cd agents && make test

# NLP API
nlp-api:
	@echo "ğŸ§  Starting NLP API server..."
	cd nlp_system && make api

nlp-test:
	@echo "ğŸ§ª Testing NLP system..."
	cd nlp_system && make test

# Web API
web-api:
	@echo "ğŸŒ Starting Web API server..."
	cd web && python app.py

web-test:
	@echo "ğŸ§ª Testing Web system..."
	cd web && python -c "import app; print('Web app OK')"

# Run all APIs
all-apis:
	@echo "ğŸš€ Starting all API servers..."
	@echo "Starting Agents API on port 5003..."
	cd agents && nohup make api-bg > ../logs/agents_api.log 2>&1 &
	@echo "Starting NLP API on port 5004..."
	cd nlp_system && nohup make api-bg > ../logs/nlp_api.log 2>&1 &
	@echo "Starting Web API on port 5005..."
	cd web && nohup python app.py > ../logs/web_api.log 2>&1 &
	@echo "âœ… All APIs started"
	@echo "ğŸ“‹ Check logs:"
	@echo "  - Agents: tail -f logs/agents_api.log"
	@echo "  - NLP: tail -f logs/nlp_api.log"
	@echo "  - Web: tail -f logs/web_api.log"

# Run all tests
all-tests:
	@echo "ğŸ§ª Running all tests..."
	$(MAKE) agents-test
	$(MAKE) nlp-test
	$(MAKE) web-test
	@echo "âœ… All tests completed"

# Clean temporary files
clean:
	@echo "ğŸ§¹ Cleaning temporary files..."
	find . -name "*.pyc" -delete
	find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	find . -name "*.log" -delete
	rm -rf logs/*.log
	@echo "âœ… Cleaned up"

# Lint code
lint:
	@echo "ğŸ” Linting code..."
	@if command -v flake8 >/dev/null 2>&1; then \
		find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | xargs flake8; \
	else \
		echo "âš ï¸ flake8 not installed, skipping linting"; \
	fi

# Format code
fmt:
	@echo "ğŸ¨ Formatting code..."
	@if command -v black >/dev/null 2>&1; then \
		find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | xargs black; \
	else \
		echo "âš ï¸ black not installed, skipping formatting"; \
	fi

# Stop all background processes
stop:
	@echo "ğŸ›‘ Stopping all background processes..."
	pkill -f "agent_api.py" || true
	pkill -f "nlp_api.py" || true
	pkill -f "web/app.py" || true
	@echo "âœ… Stopped all processes"

# Status check
status:
	@echo "ğŸ“Š AI System Status"
	@echo "==================="
	@echo "Agents API:"
	@curl -s http://localhost:5003/health >/dev/null && echo "  âœ… Running" || echo "  âŒ Not running"
	@echo "NLP API:"
	@curl -s http://localhost:5004/health >/dev/null && echo "  âœ… Running" || echo "  âŒ Not running"
	@echo "Web API:"
	@curl -s http://localhost:5005/health >/dev/null && echo "  âœ… Running" || echo "  âŒ Not running"

# Development setup
dev-setup: install
	@echo "ğŸ› ï¸ Setting up development environment..."
	mkdir -p logs
	touch logs/agents_api.log logs/nlp_api.log logs/web_api.log
	@echo "âœ… Development setup completed"

# Production setup
prod-setup: install
	@echo "ğŸ­ Setting up production environment..."
	mkdir -p logs
	@echo "âœ… Production setup completed"


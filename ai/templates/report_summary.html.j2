Thêm tham số month/year vào /report/summary để lọc dữ liệu và hiển thị thời gian truy vấn?
Thêm bảng chi tiết top keyphrases theo từng sản phẩm dưới biểu đồ
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Báo cáo tổng hợp AI4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>
  <body class="bg-gradient-to-br from-slate-50 to-indigo-50 text-gray-900 min-h-screen">
    <div class="max-w-7xl mx-auto py-8 px-4">
      <header class="mb-8">
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-indigo-600 via-sky-500 to-cyan-400 p-6 text-white shadow">
          <div class="flex items-end justify-between gap-4 flex-wrap">
            <div class="flex items-start gap-3">
              <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white/20">
                <!-- Chart icon -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l3-3 3 3 4.5-4.5 6 6M3 3v18a.75.75 0 00.75.75H21" />
                </svg>
              </span>
              <div>
                <h1 class="text-3xl font-bold">Báo cáo tổng hợp</h1>
                <p class="text-sm text-white/80 mt-1">Nguồn dữ liệu: MySQL (orders, product_comments). Generated at {{ generated_at }}</p>
              </div>
            </div>
            <form method="get" class="flex items-center gap-2 bg-white/10 backdrop-blur px-2 py-2 rounded-xl">
              <input type="number" name="month" min="1" max="12" value="{{ params.month or '' }}" placeholder="Tháng" class="border-0 bg-white px-3 py-2 text-sm rounded"/>
              <input type="number" name="year" min="2000" max="2100" value="{{ params.year or '' }}" placeholder="Năm" class="border-0 bg-white px-3 py-2 text-sm rounded"/>
              <button type="submit" class="bg-white text-indigo-700 text-sm px-4 py-2 rounded font-medium hover:bg-slate-100">Lọc</button>
            </form>
          </div>
        </div>
      </header>

      <!-- KPI Cards -->
      <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center gap-2 text-gray-500 text-sm">
            <!-- Revenue icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-emerald-500"><path d="M12 1.5a.75.75 0 01.75.75v.66a6.75 6.75 0 015.34 3.268.75.75 0 01-1.286.77A5.25 5.25 0 0012.75 4.1v7.8a5.25 5.25 0 004.054 5.148.75.75 0 11-.36 1.458A6.75 6.75 0 0112 13.65v-8.8A6.75 6.75 0 006.21 7.66a.75.75 0 01-1.286-.77A8.25 8.25 0 0111.25 2.91V2.25A.75.75 0 0112 1.5z"/></svg>
            <span>Tổng doanh thu</span>
          </div>
          <div class="text-2xl font-semibold mt-1">{{ revenue.summary.total | default(0) }}</div>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center gap-2 text-gray-500 text-sm">
            <!-- Timeline icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-indigo-500"><path d="M2.25 12a.75.75 0 01.75-.75h6a.75.75 0 010 1.5h-6A.75.75 0 012.25 12zM14.25 12a.75.75 0 01.75-.75h6a.75.75 0 010 1.5h-6a.75.75 0 01-.75-.75z"/><path d="M10.5 5.25a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM19.5 18.75a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/></svg>
            <span>Số mốc thời gian</span>
          </div>
          <div class="text-2xl font-semibold mt-1">{{ revenue.data | length }}</div>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center gap-2 text-gray-500 text-sm">
            <!-- Comments icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-rose-500"><path d="M7.5 3.75h9A3.75 3.75 0 0120.25 7.5v5.25A3.75 3.75 0 0116.5 16.5H9.28l-3.78 2.835A.75.75 0 013 18.75V7.5A3.75 3.75 0 016.75 3.75h.75z"/></svg>
            <span>Tổng bình luận</span>
          </div>
          <div class="text-2xl font-semibold mt-1">{{ sentiment.overall.positive + sentiment.overall.neutral + sentiment.overall.negative }}</div>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center gap-2 text-gray-500 text-sm">
            <!-- Products icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-amber-500"><path d="M3 7.5l9-4.5 9 4.5-9 4.5-9-4.5z"/><path d="M3 12l9 4.5 9-4.5"/></svg>
            <span>Sản phẩm theo dõi</span>
          </div>
          <div class="text-2xl font-semibold mt-1">{{ sentiment.products | length }}</div>
        </div>
      </section>

      <!-- Charts -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
          <h2 class="text-lg font-semibold mb-2">Doanh thu theo thời gian</h2>
          <div id="rev_chart" class="h-80"></div>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
          <h2 class="text-lg font-semibold mb-2">Tổng quan cảm xúc</h2>
          <div id="sent_overall" class="h-80"></div>
        </div>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
          <h2 class="text-lg font-semibold mb-2">Top sản phẩm (tiêu cực)</h2>
          <div id="sent_topneg" class="h-80"></div>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
          <h2 class="text-lg font-semibold mb-2">Từ khóa nhận xét (tiêu cực)</h2>
          {% set top_list = (sentiment.products | first).top_negative_keyphrases if (sentiment.products | length) > 0 else [] %}
          {% if top_list %}
          <div class="flex flex-wrap gap-2">
            {% for k in top_list %}
              <span class="px-2 py-1 rounded bg-red-50 text-red-700 text-xs">{{ k }}</span>
            {% endfor %}
          </div>
          {% else %}
            <p class="text-sm text-gray-500">Chưa có dữ liệu.</p>
          {% endif %}
        </div>
      </section>

      <section class="bg-white rounded-xl shadow p-4 mb-8">
        <h2 class="text-lg font-semibold mb-3">Bảng chi tiết keyphrases theo sản phẩm</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b">
                <th class="py-2 pr-4">Sản phẩm</th>
                <th class="py-2 pr-4">Positive/Neutral/Negative</th>
                <th class="py-2 pr-4">Keyphrases (Negative)</th>
              </tr>
            </thead>
            <tbody>
              {% for p in sentiment.products %}
              <tr class="border-b hover:bg-gray-50">
                <td class="py-2 pr-4">
                  {% if p.slug %}
                    <a href="/product/{{ p.slug }}" class="text-blue-600 hover:underline">{{ p.name or ('PID ' ~ p.product_id) }}</a>
                  {% else %}
                    {{ p.name or ('PID ' ~ p.product_id) }}
                  {% endif %}
                </td>
                <td class="py-2 pr-4">
                  {{ p.counts.positive }}/{{ p.counts.neutral }}/{{ p.counts.negative }}
                </td>
                <td class="py-2 pr-4">
                  {% for k in p.top_negative_keyphrases %}
                    <span class="px-2 py-1 mr-1 mb-1 inline-block rounded bg-red-50 text-red-700">{{ k }}</span>
                  {% else %}
                    <span class="text-gray-400">—</span>
                  {% endfor %}
                </td>
              </tr>
              {% else %}
              <tr><td colspan="3" class="py-3 text-center text-gray-500">Chưa có dữ liệu.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section class="mt-10">
        <div class="rounded-2xl bg-white shadow p-6">
          <div class="flex items-center gap-2 mb-3">
            <!-- Info icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-sky-600"><path d="M12 2.25a9.75 9.75 0 100 19.5 9.75 9.75 0 000-19.5zM12.75 7.5a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM9.75 10.5a.75.75 0 000 1.5h1.5v4.5a.75.75 0 001.5 0v-4.5h1.5a.75.75 0 000-1.5h-4.5z"/></svg>
            <h3 class="text-base font-semibold">Data Sources & Timestamp</h3>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
            <div>
              <div class="text-gray-500">Datasets</div>
              <div class="mt-1">orders, product_comments, products</div>
            </div>
            <div>
              <div class="text-gray-500">Parameters</div>
              <div class="mt-1">month={{ params.month | default('-') }}, year={{ params.year | default('-') }}</div>
            </div>
            <div>
              <div class="text-gray-500">Generated at</div>
              <div class="mt-1">{{ generated_at }}</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const rev = {{ revenue | tojson }};
      const sent = {{ sentiment | tojson }};

      // Revenue line chart
      const revX = (rev.data || []).map(d => d.month);
      const revY = (rev.data || []).map(d => d.revenue);
      Plotly.newPlot('rev_chart', [{x: revX, y: revY, type: 'scatter', mode: 'lines+markers', name: 'Revenue', line: {color: '#2563eb'}}], {margin: {t: 20}});

      // Top products by negative count (bar)
      const prods = (sent.products || []).slice(0, 10);
      const prodNames = prods.map(p => 'PID ' + p.product_id);
      const prodNeg = prods.map(p => p.counts.negative);
      Plotly.newPlot('sent_topneg', [{x: prodNames, y: prodNeg, type: 'bar', name: 'Negative', marker: {color: '#ef4444'}}], {margin: {t: 20}});

      // Overall sentiment pie
      const overall = sent.overall || {positive:0, neutral:0, negative:0};
      Plotly.newPlot('sent_overall', [{
        values: [overall.positive, overall.neutral, overall.negative],
        labels: ['Positive','Neutral','Negative'],
        type: 'pie'
      }], {margin: {t: 20}});
    </script>
  </body>
  </html>


